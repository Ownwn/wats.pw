<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Problem</title>
</head>
<body>

<div id="editorsBox">
    <pre class="console">PRE VIEW RESPONSE</pre>
    <div id="editorpreview" class="editors"></div>
    <div id="editorinput" class="editors"></div>
</div>

<br>
<br>

<div class="cent">
    <button class="button" onclick="check()">Submit</button>
</div>


</body>
</html>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.43.3/ace.min.js" type="text/javascript"
        charset="utf-8"></script>
<script th:inline="javascript">
    let editorPreview;
    let editorInput;

    const id = /*[[${id}]]*/ 'UNKNOWN'
    document.title = "Problem " + String(id);

    initEditors()

    function fixIndents(content, template) {
        return content.split("\n").map(l => getReplacementIndent(template) + l).join("\n")
    }

    function getReplacementIndent(template) {
        let enclosingLine = template.split("\n").filter(l => l.includes("TARGET REPLACEMENT 473882928347567473734"))[0].replace("TARGET REPLACEMENT 473882928347567473734", "")

        let indentLength = enclosingLine.trim().length !== 0 ? 0 : enclosingLine.length;
        return " ".repeat(indentLength)
    }

    function updatePreview(content) {
        const template = /*[[${challenge}]]*/ 'a\nTARGET REPLACEMENT 473882928347567473734\n'

        if (!template) {
            throw new Error("Failed to load template!")
        }

        let userInputCleaned = content.trim() === "" ? getReplacementIndent(template) + "[???]" : fixIndents(content.trim(), template)

        const replacement = template.replace(RegExp(" *TARGET REPLACEMENT 473882928347567473734 *"), userInputCleaned)

        editorPreview.setValue(replacement, -1)
    }


    async function check() {
        let ans = editorInput.getValue();
        setResponse("Loading...")
        document.querySelector('.button').innerText  = "Loading..."

        let response = await fetch("check?id=" + id, {
            method: "POST",
            body: ans + " "
        })
        setResponse(await response.text());
    }

    function setResponse(response) {
        document.querySelector('.button').innerText  = "Submit"
        document.querySelector('.console').innerText  = response
    }

    function styleEditor(editor) {
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/java");
        editor.setOption("keyboardHandler", "ace/keyboard/sublime")
        editor.setOption("wrap", "free")
    }

    function initEditors() {
        editorPreview = ace.edit("editorpreview");
        styleEditor(editorPreview)

        editorInput = ace.edit("editorinput");
        styleEditor(editorInput)

        editorPreview.setOption("readOnly", true)
        editorPreview.setOption("behavioursEnabled", false)
        editorPreview.setOption("highlightActiveLine", false)
        editorPreview.setOption("highlightGutterLine", false)


        updatePreview(editorInput.getValue())
        editorInput.session.on('change', function() {
            updatePreview(editorInput.getValue())
        });
    }

</script>

<style>

    .editors, .console {
        border: 4px solid #e0e0e0;
        width: 34vw;
        height: 80vh;
        margin: 10px 5px 5px;

        box-sizing: border-box;
    }
    .editors {
        font-size: 18px;
    }

    #editorsBox {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;


    }

    #editorpreview {

    }

    #editorinput {

    }

    .button {

        width: 500px;
        height: 75px;
        background-color: #959595;
        border-radius: 10px;
        border: 0;
        font-size: 40px;
    }
    .cent {
        text-align: center;
    }

    .console {
        background-color: red;
        padding: 10px;
        font-size: 20px;


        white-space: pre-wrap;
    }

    body {
        color: #e0e0e0;
        background-color: #141414;

        font-family: Arial, sans-serif;
        margin: 0;

        /*display: grid;*/
        /*justify-items: center;*/

        background-image: radial-gradient(circle at 15% 15%, hsla(0, 100%, 35%, 0.2), transparent 40%),
        radial-gradient(circle at 85% 75%, hsla(0, 100%, 28%, 0.15), transparent 40%);

        background-repeat: no-repeat;
    }

    html, body {
        height: 100%;
    }
</style>